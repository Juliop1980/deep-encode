---
title: "SCA_SS2021_Gruppe202_Gruppe204"
author: "Linus, Amira, Yue, Vinzenz"
date: "26 6 2021"
output: pdf_document
---

#Aufgaben Modell:
```{r}
#mehr oder weniger so wie in HA3 von Amira und mir
cat("
1) alle Daten in trips Agg Raw
Es fehlen Wetterdaten (Linus aufgabe von vor 3 Wochen, z.B. Sonneschein Faktor, Grad, Niederschlag in Liter pro Stunde etc.) und die Zeit die bei Schleusen gebraucht wird (Linus aufgabe zu heute)
besondereEreignisse, Ferien, Wochentag usw. bereits drin)
Vielleicht fehlt noch eine weitere")
cat("
2) OTD oder sowas über den Datenpunkt
für jeden trip, guckt mal in Isis die verschiedenen Werte, wenn nichts passt, nehmen wir einen eigenen Wert)")
cat("
3) stärksten correlierenden Effekte gegenüber unserer 2) raussuchen
  siehe HA3:  
  
  # Unsortierte Tabelle mit externen Effekten in Korrelation zur IFR
korrelationIFR = data.frame(t(cor(AHLexternals$IFR, AHLexternals[c(6:27)])))
colnames(korrelationIFR) = c(Korrelation)
korrelationIFR$Korrelation = round(korrelationIFR$Korrelation, 3)
korrelationIFR ")
cat("
4) Lineare Regression:
  5) Baseline ausrechnen (durchschnitt von unser in 2) gewählten On time Delivery oder sowas)
  
  6) nach Fehlerkennzahlen bewerten (MAE, SMape, mape etc.)
  
  7) In trainings und test set aufteilen (set.seed(122313))
  
  ")
cat("
8) Forward Selection: 
  9) Univaritante ( model1 = lm(..), model2 = lm(...) usw.)
  10) immer weiter machen bis zum Ende (schleifen = menge an Variablen)
11) Ergebnisse gegenüber den anderen testset testen
")
cat("
12) leicht anders: kriegen wir den lower, upper, und fit, mit predict 
")
```



<!-- install.packages("ggmap") -->
<!-- install.packages("dplyr") -->
<!-- install.packages("datetime") -->


```{r, eval=FALSE}
# install.packages("dummies")
# install.packages("ggplot2")
# install.packages("Metrics")
# install.packages("GGally")
# install.packages("dplyr")
# install.packages("tidyr")
# install.packages("forecast")
# install.packages("ggmap")
# install.packages("datetime")
```

```{r}
library("dummies")
library("ggplot2")
library("Metrics")
library("GGally")
library("dplyr")
library("tidyr")
library("forecast")
library("ggmap")
library("datetime")
```





#Daten einlesen
```{r}
tripsAgg_Raw = read.csv2("trips_aggregated.csv",sep=",")
tripsRaw = read.csv2("trips_raw.csv",sep=",")
waterLevel = read.csv2("water_levels.csv",sep=",")
waterLevelStations = read.csv2("water_levels_stations.csv",sep=",")
schleuse = read.csv2("schleusen.csv", sep = ",")
haefen = read.csv2("haefen.csv",sep = ",")
Feiertage = read.csv2("GesetzlicheFeiertage_2019.csv", sep = ",")
ferienAll = read.csv2("FerienAll.csv", sep =",")
ferien = read.csv2("Ferien.csv", sep =",")
besondereEreignisse = read.csv2("Probleme2019.csv", sep = ",")
wetter_stationen = read.csv2("wetter_stations.csv", sep = ",")
```





#Summary/head/str
```{r}
summary(tripsAgg_Raw)
summary(tripsRaw)
summary(waterLevel)
summary(waterLevelStations)
summary(ferienAll)
summary(besondereEreignisse)
summary(wetter_stationen)
str(tripsAgg_Raw)
str(tripsRaw)
str(waterLevel)
str(waterLevelStations)
str(wetter_stationen)
head(tripsAgg_Raw)
head(tripsRaw)
head(waterLevel)
head(waterLevelStations)
head(wetter_stationen)
```


# transform Data und Data bereinigen
```{r}
# trips  -> Koordinaten char -> Int
tripsAgg_Raw$longitudeStart = as.numeric(tripsAgg_Raw$longitudeStart)
tripsAgg_Raw$longitudeEnd = as.numeric(tripsAgg_Raw$longitudeEnd)
tripsAgg_Raw$latitudeStart = as.numeric(tripsAgg_Raw$latitudeStart)
tripsAgg_Raw$latitudeEnd = as.numeric(tripsAgg_Raw$latitudeEnd)
tripsAgg_Raw$length = as.numeric(tripsAgg_Raw$length)
tripsAgg_Raw$width = as.numeric(tripsAgg_Raw$width)
tripsAgg_Raw$draught = as.numeric(tripsAgg_Raw$draught)
tripsAgg_Raw$currentSpeedOverGround = as.numeric(tripsAgg_Raw$currentSpeedOverGround)
tripsAgg_Raw$timeStart = as.POSIXlt(tripsAgg_Raw$timeStart)
tripsAgg_Raw$timeEnd = as.POSIXlt(tripsAgg_Raw$timeEnd)
tripsAgg_Raw$timestampEta = as.POSIXlt(tripsAgg_Raw$timestampEta, format="%Y-%m-%d %H:%M:%S")
tripsAgg_Raw$typeOfShipId = as.factor(tripsAgg_Raw$typeOfShipId)
tripsAgg_Raw$dimA = as.numeric(tripsAgg_Raw$dimA)
tripsAgg_Raw$dim = as.numeric(tripsAgg_Raw$dim)
tripsAgg_Raw$dimC = as.numeric(tripsAgg_Raw$dimC)
tripsAgg_Raw$dimD = as.numeric(tripsAgg_Raw$dimD)
# replace rows with NA in draught if wert <= 2
tripsAgg_Raw$draught[which(tripsAgg_Raw$draught <= 2)] <- NA
# raw_trip
tripsRaw$speedOverGround = as.numeric(tripsRaw$speedOverGround)
tripsRaw$longitude = as.numeric(tripsRaw$longitude)
tripsRaw$latitude = as.numeric(tripsRaw$latitude)
tripsRaw$typeOfShipId = as.factor(tripsRaw$typeOfShipId)
tripsRaw$length = as.numeric(tripsRaw$length)
tripsRaw$width = as.numeric(tripsRaw$width)
tripsRaw$draught = as.numeric(tripsRaw$draught)
tripsRaw$timestampPosition = as.POSIXct(tripsRaw$timestampPosition, format="%Y-%m-%d %H:%M:%S")
# replace rows with NA in draught if wert <= 2
tripsRaw$draught[which(tripsAgg_Raw$draught <= 2)] <- NA
#Schleuse
schleuse$latitude = as.numeric(schleuse$latitude)
schleuse$longitude = as.numeric(schleuse$longitude)
#haefen
haefen$latitude = as.numeric(haefen$latitude)
haefen$longitude = as.numeric(haefen$longitude)
#waterlevel
waterLevel$id = as.factor(waterLevel$id)
waterLevelStations$id = as.factor(waterLevelStations$id)
# Destination als ROTTERDAM
# Datenbereinigung:
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "RQTTERDAM"] <- "ROTTERDAM"
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "ROTTEERDAM"] <- "ROTTERDAM"
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "NLRTM00697DOCKX0001"] <- "ROTTERDAM"
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "NLRTM01012DOCKX00012"] <- "ROTTERDAM"
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "NLRTM01201DOCKX00015"] <- "ROTTERDAM"
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "NLRTM01202DOCKX0003"] <- "ROTTERDAM"
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "NLRTM01202DOCKX00038"] <- "ROTTERDAM"
tripsAgg_Raw$destination[tripsAgg_Raw$destination == "NLXXX01207DOCKX00012"] <- "ROTTERDAM"
# Feiertage 2019
Feiertage$Datum = as.Date(Feiertage$Datum, format = "%d %B %Y" )
#Quellen
#https://fryslan-sailor.com/praktische-infos/schulferien-niederlande
#https://www.schulferien.org/deutschland/ferien/2019/
#https://www.elwis.de/DE/dynamisch/mvc/main.php?modul=schleuse&action=search
#https://www.dwd.de/DE/leistungen/besondereereignisse/stuerme/download_tabelle.html
cat("Niederschlag nur einmal von Bedeutung")
#numeric machen
ferien$longitudeStart = as.numeric(ferien$longitudeStart)
ferien$longitudeEnd = as.numeric(ferien$longitudeEnd)
ferien$latitudeStart = as.numeric(ferien$latitudeStart)
ferien$latitudeEnd = as.numeric(ferien$latitudeEnd)
besondereEreignisse$longitude = as.numeric(besondereEreignisse$longitude)
besondereEreignisse$latitude = as.numeric(besondereEreignisse$latitude)
besondereEreignisse$longitudeEnde = as.numeric(besondereEreignisse$longitudeEnde)
#zum Date Format
ferienAll$ferienStart <- as.Date(ferienAll$ferienStart, format = "%Y-%m-%d")
ferienAll$ferienEnde <- as.Date(ferienAll$ferienEnde, format = "%Y-%m-%d")
besondereEreignisse$Start <- as.Date(besondereEreignisse$Start, format = "%Y-%m-%d")
besondereEreignisse$Ende <- as.Date(besondereEreignisse$Ende, format = "%Y-%m-%d")
tripsRaw$timestampPositionDate <- as.Date(tripsRaw$timestampPosition, format = "%Y-%m-%d")
#numeric machen
ferienAll$longitudeStart = as.numeric(ferienAll$longitudeStart)
ferienAll$longitudeEnd = as.numeric(ferienAll$longitudeEnd)
ferienAll$latitudeStart = as.numeric(ferienAll$latitudeStart)
ferienAll$latitudeEnd = as.numeric(ferienAll$latitudeEnd)
```

# Dauer der Tour einfuegen und Daten transformation
```{r}
#Weekday für alle Daten
waterLevel$weekday <- strftime(waterLevel$measuretime, "%A")
tripsAgg_Raw$weekdayStart <- strftime(tripsAgg_Raw$timeStart, "%A")
tripsAgg_Raw$weekdayStartNumber <- as.numeric(strftime(tripsAgg_Raw$timeStart, "%w"))
tripsAgg_Raw$StartMonth <-strftime(tripsAgg_Raw$timeStart, "%B")
tripsAgg_Raw$weekdayEnd <- strftime(tripsAgg_Raw$timeEnd, "%A")
tripsAgg_Raw$weekdayEndNumber <- as.numeric(strftime(tripsAgg_Raw$timeEnd, "%w"))
tripsAgg_Raw$Datum <- as.Date(tripsAgg_Raw$timeEnd, format = "%y-%m-%d")
#Dauer der Tour
tripsAgg_Raw$dauerTourTage = as.vector(difftime(tripsAgg_Raw$timeEnd, tripsAgg_Raw$timeStart, units='days'))
tripsAgg_Raw$dauerTourStunden = as.vector(difftime(tripsAgg_Raw$timeEnd, tripsAgg_Raw$timeStart, units='hours'))
#als nummer (0=Sonntag)
waterLevel$weekdayNumber <- as.numeric(strftime(waterLevel$measuretime, "%w"))
#als Monat
waterLevel$monat <- strftime(waterLevel$measuretime, "%m")
tripsAgg_Raw$monatStartNumber <- as.numeric(strftime(tripsAgg_Raw$timeStart, "%m"))
tripsAgg_Raw$monatEndtNumber <- as.numeric(strftime(tripsAgg_Raw$timeEnd, "%m"))
tripsAgg_Raw$weekdayEndNumber <- as.numeric(strftime(tripsAgg_Raw$timeEnd, "%w"))
tripsAgg_Raw$WocheStartNumber <- as.numeric(strftime(tripsAgg_Raw$timeStart, "%U"))
tripsAgg_Raw$WocheEndtNumber <- as.numeric(strftime(tripsAgg_Raw$timeEnd, "%U"))
# # Triptime of different Ship
# ggplot(tripsAgg_Raw, aes(Datum, dauerTourStunden, colour = typeOfShipId))+ geom_line()
# # Triptime 
# ggplot(tripsAgg_Raw, aes(Datum, dauerTourStunden))+ geom_line()
```


```{r}
# Wetter Daten
wetter_stationen$tavg = as.numeric(wetter_stationen$tavg)
wetter_stationen$wspd = as.numeric(wetter_stationen$wspd)
wetter_stationen$prcp = as.numeric(wetter_stationen$prcp)
wetter_stationen$date = as.Date(wetter_stationen$date, format = "%Y-%m-%d")
wetter_nach_tagen = aggregate(tavg~date, wetter_stationen, mean )
wetter_nach_tagen$wspd= aggregate(wspd~date, wetter_stationen, mean )$wspd
wetter_nach_tagen$prcp= aggregate(prcp~date, wetter_stationen, mean )$prcp
wetter_nach_tagen
names(wetter_nach_tagen)[1] = "timestampPositionDate"
tripsRaw = merge(tripsRaw, wetter_nach_tagen, "timestampPositionDate")
tripsAgg_Raw$tavg = aggregate(tavg ~ tripName, data = tripsRaw, mean)$tavg
tripsAgg_Raw$wspd = aggregate(wspd ~ tripName, data = tripsRaw, mean)$wspd
tripsAgg_Raw$prcp = aggregate(prcp ~ tripName, data = tripsRaw, mean)$prcp
```


```{r} 
trip = data.frame(tripsAgg_Raw[,2])
schleusenPosLng = schleuse[1,3]
tripsAgg_Raw$Schleuse = 0
for(i in 1:nrow(trip)) {
 
      cat(max(tripsRaw[tripsRaw$tripName==trip[i , 1]  & tripsRaw$longitude<schleusenPosLng-0.025, c("longitude")])) 
      trip[i , 2] = max(tripsRaw[tripsRaw$tripName==trip[i , 1] & tripsRaw$longitude<schleusenPosLng-0.025, c("longitude")])
      trip[i , 3] = min(tripsRaw[tripsRaw$tripName==trip[i , 1] & tripsRaw$longitude>schleusenPosLng+0.025, c("longitude")])
      trip[i , 4] = min(tripsRaw[tripsRaw$tripName==trip[i , 1] &tripsRaw$longitude== trip[i , 2], c("timestampPosition")])
      trip[i , 5] = min(tripsRaw[tripsRaw$tripName==trip[i , 1] &tripsRaw$longitude== trip[i , 3], c("timestampPosition")])
      
      trip[i , 6] =   difftime( trip[i , 4], trip[i , 5], units='hour')
}
    names(trip)[1] = "tripName"
names(trip)[6] = "Schleuse"
tripsAgg_Raw$SchleusenZeit = as.numeric(aggregate(Schleuse ~ tripName, data = trip, sum)$Schleuse)
```

# Differenz: geplante Ankunft - IST-Ankunft (negativ=zu lang) 
# Gibt kein Sinn. AIS zu fehlerhaft 
```{r}
tripsAgg_Raw <- tripsAgg_Raw %>%
  mutate(delay = difftime(timestampEta, timeEnd, units='hours')) 
  
```


#Dauer ohne Pause erstellen
```{r}
# Pause(if speed <= 0.5) for each trip in TripRaw
tripsRaw$CountSpeed0<-ifelse(tripsRaw$speedOverGround<=0.5,T,F)
# count how many breaks did ship have
Pause <- aggregate(CountSpeed0~tripName, tripsRaw, sum)
# each break is 10 mins(Estimation), because Interval of measuretime is every 10~20 mins, unit as hour
Pause$PauseTime = (Pause$CountSpeed0)*10/60
# add Pausetime to tripAgg
tripsAgg_Raw= left_join(tripsAgg_Raw, Pause, by = 'tripName') %>%
  mutate(DauerohnePause = dauerTourStunden-PauseTime)
ggplot(tripsAgg_Raw, aes(Datum, dauerTourStunden, colour = typeOfShipId))+ geom_point()
# different ships with Dauer without Pause: Ausreisser finden 
ggplot(tripsAgg_Raw, aes(typeOfShipId, DauerohnePause))+ geom_point()
ggplot(tripsAgg_Raw, aes(typeOfShipId, dauerTourStunden))+ geom_point()
```
# Durchschnittliche Geschwindigkeit
```{r}
Av_Speed <- aggregate(speedOverGround~tripName, tripsRaw, mean)
tripsAgg_Raw<- merge(tripsAgg_Raw,Av_Speed, by = "tripName")
```

# Durchschnittliche Geschwindigkeit mit Type of Ships
```{r}
ggplot(tripsAgg_Raw, aes(weekdayStart, speedOverGround, colour = typeOfShipId))+ geom_point()
# average spped of type of ships
aggregate(speedOverGround~typeOfShipId,tripsAgg_Raw,mean)
# count different ships with weekdaystart 
tripsAgg_Raw%>%
  group_by(typeOfShipId)%>%
  count(weekdayStart)
cat("80 ist schneller und 70 ist langsamer")
```

# Visualisierung von Start/Endtag 
```{r}
# Datenvisualisierung
ggplot(tripsAgg_Raw, aes(x = factor(weekdayStart, level = c('Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag')))) +
  geom_bar(fill = "cornflowerblue") +
  geom_text(stat='count', aes(label=..count..), vjust=-1) +
  expand_limits(y = c(0, 40)) +
  labs(title = "Häufigkeit des Wochentags als Start", x = "Wochentag", y = "Häufigkeit")
cat("Die meisten Fahrten starten an einem Dienstag. \n")
ggplot(tripsAgg_Raw, aes(x = factor(weekdayEnd, level = c('Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag')))) +
  geom_bar(fill = "cornflowerblue") +
  geom_text(stat='count', aes(label=..count..), vjust=-1) +
  expand_limits(y = c(0, 40)) +
  labs(title = "Häufigkeit des Wochentags als Ende", x = "Wochentag", y = "Häufigkeit")
cat("Die meisten Fahrten enden an einem Sonntag. \n ")
# StartTag als Variablen zur Dauer 
# Start Tag und Dauer: die Ships, am Sonntag startet, daueren laengerer
Dauer_StartTag = aggregate(dauerTourStunden ~ weekdayStart, tripsAgg_Raw, mean)
Dauer_StartTag = Dauer_StartTag[order(Dauer_StartTag$`dauerTourStunden`, decreasing = TRUE),] 
Dauer_StartTag
# End Tag und Dauer: die Ships, am Sonntag ankommen, daueren laengerer 
Dauer_StartEnd = aggregate(dauerTourStunden ~ weekdayEnd, tripsAgg_Raw, mean)
Dauer_StartEnd = Dauer_StartEnd[order(Dauer_StartEnd$`dauerTourStunden`, decreasing = TRUE),] 
Dauer_StartEnd
# Dauer mit Month keine Auffaeligkeit
Deuer_Month = aggregate(dauerTourStunden ~ StartMonth, tripsAgg_Raw, mean )
```

# Feather: ob Sonntag:# Spalten ob Schiff am Sonntag start und ankommt erstellen
```{r}
# StartSon(if Sonntag, True) 
tripsAgg_Raw$StartSon<-ifelse(tripsAgg_Raw$weekdayStart== "Sonntag",T,F)
# End(if Sonntag, True)
tripsAgg_Raw$EndSon<-ifelse(tripsAgg_Raw$weekdayEnd== "Sonntag",T,F)
## Start am Sonntag dauer langer 
```





# Feather: waterlevel
# merge waterlevel and waterlevelstation to Koordinaten_waterLevel
```{r}
# mit ID zwei Tabelle verbinden; Variable Measuretime als Tag umstellen
Koordinaten_waterLevel= left_join(waterLevel, waterLevelStations, by = 'id') %>%
  select(2,3,4,7,8)%>%
  separate(col = 'measuretime', into = c("Datum", "Time"), sep = " ")
Koordinaten_waterLevel$Datum = as.Date(Koordinaten_waterLevel$Datum)
Koordinaten_waterLevel$WaterLevel = as.numeric(Koordinaten_waterLevel$value)
```

# Feather: waterlevel
# visualisierung waterlevel of 11 stations in 2019
```{r}
ggplot(Koordinaten_waterLevel, aes(Datum, WaterLevel, colour = id))+ geom_line()
## ID FTS49972718333 hat die meisten Niederschläge, Koordination: 49.972718333, 7.900803333
## ID FTS5010648 (50.10648, 8.716451667) hat die wenigesten Niederschlage.Es ist auch Endstation
## Sasionlitaet: Maerz bis April, Mai bis Juni, Dezember bis Janaur mehr Wasser!
## Sasionlitaet: Trockenzeit Sep bis Okot! 
```
# Feather: waterlevel
#waterLevel and tripAgg_Raw verbinden
```{r}
#mittelwert von untershiedlichen Messstationen
waterlevel_mean <-aggregate(WaterLevel~Datum,Koordinaten_waterLevel, mean)
# Warerlevel_mean zu tripsAgg_Raw einfugen
tripsAgg_Raw= left_join(tripsAgg_Raw, waterlevel_mean, by = 'Datum')
```


#Bundesland fertig
```{r}
#Bundesland richtig
tripsRaw$bundesland= ifelse((tripsRaw$longitude >= ferienAll[ferienAll$Bundesland == "Hessen1",]$longitudeStart), "Hessen" , ifelse((tripsRaw$longitude >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz1",]$longitudeStart), "RheinlandPfalz" , ifelse((tripsRaw$longitude >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen1",]$longitudeStart), "NordrheinWestfahlen" , ifelse((tripsRaw$longitude >= ferienAll[ferienAll$Bundesland == "GelderlandSud1",]$longitudeStart), "GelderlandSud" , ifelse((tripsRaw$longitude >= ferienAll[ferienAll$Bundesland == "Sudholland1",]$longitudeStart), "Sudholland" , "nooooooo")))))
#Bundeslander Grenzübergänge
qmplot(longitudeStart, latitudeStart, data = ferienAll, maptype = "terrain", zoom = 7, color = I("red"))
```

#Ferien alle --> Fertig
```{r}
cat("Aufgrund des Zeichen Limits bei Funktionen, habe ich diesen relativ hässlichen Weg gewählt!")
#Nordrhein_Westfalen Ferien
#1 Ja Ferien
#2 Nein keine Ferien
tripsRaw$bundeslandNordrheinWestfahlen01 = ifelse(tripsRaw$bundesland == "NordrheinWestfahlen", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen1",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen2",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen3",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen4",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen5",]$ferienEnde), 1 , 0))))), 0)
tripsRaw$bundeslandNordrheinWestfahlenSchriftlich =  ifelse(tripsRaw$bundesland == "NordrheinWestfahlen",ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen1",]$ferienEnde),"NordrheinWestfahlen 1 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen2",]$ferienEnde),"NordrheinWestfahlen 2 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen3",]$ferienEnde),"NordrheinWestfahlen 3 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen4",]$ferienEnde),"NordrheinWestfahlen 4 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "NordrheinWestfahlen5",]$ferienEnde),"NordrheinWestfahlen 5 Ferien", "keine Ferien NordrheinWestfahlen"))))), "NRW nicht")
#Hessen Ferien
#1 Ja Ferien
#2 Nein keine Ferien
tripsRaw$bundeslandHessen01 = ifelse(tripsRaw$bundesland == "Hessen", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen1",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen2",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen3",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen4",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen5",]$ferienEnde), 1 , 0))))), 0)
tripsRaw$bundeslandHessenSchriftlich = ifelse(tripsRaw$bundesland == "Hessen",ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen1",]$ferienEnde),"Hessen 1 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen2",]$ferienEnde),"Hessen 2 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen3",]$ferienEnde),"Hessen 3 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen4",]$ferienEnde),"Hessen 4 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Hessen5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Hessen5",]$ferienEnde),"Hessen 5 Ferien", "keine Ferien Hessen"))))), "Hessen nicht")
#RheinlandPfalz Ferien
#1 Ja Ferien
#2 Nein keine Ferien
tripsRaw$bundeslandRheinlandPfalz01 = ifelse(tripsRaw$bundesland == "RheinlandPfalz", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz1",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz2",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz3",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz4",]$ferienEnde),1 , ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz5",]$ferienEnde), 1 ,ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz6",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz6",]$ferienEnde), 1 , 0)))))), 0)
tripsRaw$bundeslandRheinlandPfalzSchriftlich = ifelse(tripsRaw$bundesland == "RheinlandPfalz",ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz1",]$ferienEnde),"RheinlandPfalz 1 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz2",]$ferienEnde),"RheinlandPfalz 2 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz3",]$ferienEnde),"RheinlandPfalz 3 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz4",]$ferienEnde),"RheinlandPfalz 4 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz5",]$ferienEnde),"RheinlandPfalz 5 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "RheinlandPfalz6",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "RheinlandPfalz6",]$ferienEnde),"RheinlandPfalz 6 Ferien", "keine Ferien RheinlandPfalz")))))),"Rheinland Pfalz nicht")
#GelderlandSud Ferien
#1 Ja Ferien
#2 Nein keine Ferien
tripsRaw$bundeslandGelderlandSud01 = ifelse(tripsRaw$bundesland == "GelderlandSud", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud1",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud2",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud3",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud4",]$ferienEnde),1 , ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud5",]$ferienEnde), 1 ,ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud6",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud6",]$ferienEnde), 1 , 0)))))), 0)
tripsRaw$bundeslandGelderlandSudSchriftlich = ifelse(tripsRaw$bundesland == "GelderlandSud",ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud1",]$ferienEnde),"GelderlandSud 1 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud2",]$ferienEnde),"GelderlandSud 2 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud3",]$ferienEnde),"GelderlandSud 3 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud4",]$ferienEnde),"GelderlandSud 4 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud5",]$ferienEnde),"GelderlandSud 5 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "GelderlandSud6",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "GelderlandSud6",]$ferienEnde),"GelderlandSud 6 Ferien", "keine Ferien GelderlandSud")))))),"GelderlandSud nicht")
#SudHolland Ferien
#1 Ja Ferien
#2 Nein keine Ferien
tripsRaw$bundeslandSudholland01 = ifelse(tripsRaw$bundesland == "Sudholland", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland1",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland2",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland3",]$ferienEnde),1, ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland4",]$ferienEnde),1 , ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland5",]$ferienEnde), 1 ,ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland6",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland6",]$ferienEnde), 1 , 0)))))), 0)
tripsRaw$bundeslandSudhollandSchriftlich = ifelse(tripsRaw$bundesland == "Sudholland",ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland1",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland1",]$ferienEnde),"Sudholland 1 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland2",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland2",]$ferienEnde),"Sudholland 2 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland3",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland3",]$ferienEnde),"Sudholland 3 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland4",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland4",]$ferienEnde),"Sudholland 4 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland5",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland5",]$ferienEnde),"Sudholland 5 Ferien", ifelse((tripsRaw$timestampPositionDate >= ferienAll[ferienAll$Bundesland == "Sudholland6",]$ferienStart & tripsRaw$timestampPositionDate <= ferienAll[ferienAll$Bundesland == "Sudholland6",]$ferienEnde),"Sudholland 6 Ferien", "keine Ferien Sudholland")))))),"Sudholland nicht")
#Ferien gemerged:
tripsRaw$FerienKomplett = ifelse(tripsRaw$bundeslandSudholland01 == 1 | tripsRaw$bundeslandGelderlandSud01 == 1 | tripsRaw$bundeslandRheinlandPfalz01 == 1 | tripsRaw$bundeslandHessen01 == 1 | tripsRaw$bundeslandNordrheinWestfahlen01 == 1, 1, 0)
#Ferien in tripsAgg_Raw
tripsAgg_Raw$FerienHaufigkeit = aggregate(FerienKomplett ~ tripName, data = tripsRaw, sum)$FerienKomplett
tripsAgg_Raw$FerienJaNein = ifelse(tripsAgg_Raw$FerienHaufigkeit >= 1 , 1, 0) # todo: Vinz FIX ESS!!! :)
#BesondereEreignisse
#SchleusenSperre
tripsRaw$SchleusenSperreKostheim = ifelse(tripsRaw$longitude >= besondereEreignisse[besondereEreignisse$Ort == "KostheimNordschleuse",]$longitude & tripsRaw$longitude <= besondereEreignisse[besondereEreignisse$Ort == "KostheimNordschleuse",]$longitudeEnde & tripsRaw$timestampPositionDate >= besondereEreignisse[besondereEreignisse$Ort == "KostheimNordschleuse",]$Start & tripsRaw$timestampPositionDate <= besondereEreignisse[besondereEreignisse$Ort == "KostheimNordschleuse",]$Ende, 1,0)
tripsRaw$SchleusenSperreGriesheim = ifelse(tripsRaw$longitude >= besondereEreignisse[besondereEreignisse$Ort == "GriesheimNordschleuse",]$longitude & tripsRaw$longitude <= besondereEreignisse[besondereEreignisse$Ort == "GriesheimNordschleuse",]$longitudeEnde & tripsRaw$timestampPositionDate >= besondereEreignisse[besondereEreignisse$Ort == "GriesheimNordschleuse",]$Start & tripsRaw$timestampPositionDate <= besondereEreignisse[besondereEreignisse$Ort == "GriesheimNordschleuse",]$Ende, 1, 0)
tripsRaw$SchleusenSperreOffenbach = ifelse(tripsRaw$longitude >= besondereEreignisse[besondereEreignisse$Ort == "OffenbachSchleuse",]$longitude & tripsRaw$longitude <= besondereEreignisse[besondereEreignisse$Ort == "OffenbachSchleuse",]$longitudeEnde & tripsRaw$timestampPositionDate >= besondereEreignisse[besondereEreignisse$Ort == "OffenbachSchleuse",]$Start & tripsRaw$timestampPositionDate <= besondereEreignisse[besondereEreignisse$Ort == "OffenbachSchleuse",]$Ende, 1,0)
tripsRaw$SchleusenSperreAlle = (tripsRaw$SchleusenSperreGriesheim + tripsRaw$SchleusenSperreKostheim + tripsRaw$SchleusenSperreOffenbach)
tripsAgg_Raw$SchleusenSperre = aggregate(SchleusenSperreAlle ~ tripName, data = tripsRaw, sum)$SchleusenSperre
#Orkan
#OrkanStarkEberhard
tripsRaw$OrkanEberhard = ifelse(tripsRaw$timestampPositionDate >= besondereEreignisse[besondereEreignisse$Grund == "OrkanBoenEberhardSehrStark",]$Start & tripsRaw$timestampPositionDate <= besondereEreignisse[besondereEreignisse$Grund == "OrkanBoenEberhardSehrStark",]$Ende, 1, 0)
#OrkanStarkEberhard
tripsRaw$OrkanBennet = ifelse(tripsRaw$timestampPositionDate >= besondereEreignisse[besondereEreignisse$Grund == "OrkanBoenBennetMediumStark",]$Start & tripsRaw$timestampPositionDate <= besondereEreignisse[besondereEreignisse$Grund == "OrkanBoenBennetMediumStark",]$Ende, 1, 0)
cat("Während der Orkan Phasen ist kein einziges Schiff gefahren, guter Punkt für Präsentation (vinzenz)")
tripsRaw$OrkanAlle =  (tripsRaw$OrkanEberhard + tripsRaw$OrkanBennet)
tripsAgg_Raw$Orkan = aggregate(OrkanAlle ~ tripName, data = tripsRaw, sum)$Orkan
#Niederschlag
tripsRaw$NiederschlagStark = ifelse(tripsRaw$timestampPositionDate >= besondereEreignisse[besondereEreignisse$Grund == "starkerNiederschalf",]$Start & tripsRaw$timestampPositionDate <= besondereEreignisse[besondereEreignisse$Grund == "starkerNiederschalf",]$Ende, 1, 0)
tripsAgg_Raw$NiederschlagStark = aggregate(NiederschlagStark ~ tripName, data = tripsRaw, sum)$NiederschlagStark
cat("Auch während der starken Niederschlags Phasen ist kein einziges Schiff gefahren, guter Punkt für Präsentation (vinzenz)")
#extremeHitze
tripsRaw$extremeHitze = ifelse(tripsRaw$timestampPositionDate >= besondereEreignisse[besondereEreignisse$Grund == "extremeHitze",]$Start & tripsRaw$timestampPositionDate <= besondereEreignisse[besondereEreignisse$Grund == "extremeHitze",]$Ende, 1, 0)
tripsAgg_Raw$extremeHitze = aggregate(extremeHitze ~ tripName, data = tripsRaw, sum)$extremeHitze
```




---------------------------------------------------------------------------------------

------------------------------------------------------------------

#Map
```{r}
rhein <- c(left = 2, bottom = 48, right = 13, top = 53)
get_stamenmap(rhein, zoom = 5, maptype = "terrain") %>% ggmap() 
qmplot(longitudeStart, latitudeStart, data = tripsAgg_Raw, maptype = "terrain", color = I("red"))
qmplot(longitudeEnd, latitudeEnd, data = tripsAgg_Raw, maptype = "toner-lite", color = I("red"))
qmplot(longitude, latitude, data = tripsRaw, maptype = "toner-lite", color = I("red"))
#Nur für ein Vessel:
dataVessel30 = subset(tripsRaw, vesselName == "vessel_30")
qmplot(longitude, latitude, data = dataVessel30, maptype = "terrain", color = I("blue"),zoom=8,alpha = I(.5),geom = c("bin2d","point"),extent = "normal")
#Nur für die Schleuesen:
qmplot(longitude, latitude, data = schleuse, maptype = "terrain", color = I("red"),xlab = ("Schleuse"),label=("schleuse"),titel="Schleuse",extent = "normal")
qmplot(longitude, latitude, data = schleuse, geom = c("point","density2d"))
qmplot(longitude, latitude, data = haefen, maptype = "terrain", color = I("darkblue"),extent = "normal")
qmplot(longitude, latitude, data = haefen, geom = c("point","density2d"))
dataVessel30 = subset(tripsRaw, vesselName == "vessel_30")
qmplot(longitude, latitude, data = dataVessel30, maptype = "terrain", color = I("blue"))
dataHafen = subset(tripsRaw, length == "135")
#qmplot(longitude, latitude, data = dataVesselLength13, maptype = "terrain", color = I("red"))
(
qmplot(longitude, latitude, data = dataVessel30, maptype = "toner-background", colour = "blue") + 
  facet_wrap(~ speedOverGround)
)
```





# -----------------------------------------------------------
#Yue's Versuch
#neue Spalte, 3 clusters(Abhangigkeit der Position) erzeugen
```{r} 
tripsAgg_Raw <- tripsAgg_Raw%>% mutate(tripsAgg_Raw, cluster= ifelse((longitudeStart >= 8.52499 & latitudeStart >= 50.06973 & longitudeStart <= 8.57 & latitudeStart <= 50.106), 1, ifelse(longitudeStart >= 8.556 & latitudeStart >= 50.0848 & longitudeStart <= 8.6392 & latitudeStart <= 50.096,2,3)))
tripsAgg_Raw$cluster = as.factor(tripsAgg_Raw$cluster)
ggplot(tripsAgg_Raw, aes(cluster, dauerTourStunden))+ geom_point()
```

# Geschwidigkeit der Schiffe -> Information: Pausezeit unregelmassig von Trip101
```{r}
# tripName: 
tripsRaw%>%
  filter(tripName=="trip_101")%>%
  ggplot(aes(timestampPosition, speedOverGround))+ geom_point()
  
```

```{r}
  ggplot(tripsAgg_Raw, aes(Datum, dauerTourStunden),color= typeOfShipId)+ geom_point()
```


#______________________________________________________________________________________________________

#Korrelation 
```{r}
#Todo: bessere Tabellen name
#Correlation von allen Variablen
korrelation = data.frame(round(cor(tripsAgg_Raw[,c("length","width","draught","dimA","dim","dimC","dimD","SchleusenZeit","tavg","wspd","prcp","weekdayStartNumber","weekdayEndNumber","extremeHitze","NiederschlagStark","Orkan","SchleusenSperre","WaterLevel","monatStartNumber","monatEndtNumber","FerienHaufigkeit","WocheStartNumber","WocheEndtNumber" )],tripsAgg_Raw$dauerTourStunden, use="complete.obs"),3))
korrelation
#Todo schöner ausgeben
cat("die Variablen mit der höchsten Correlation sind: FerienHaufigkeit,SchleusenSperre,Orkan,WeekdayEndNumber, extreme Hitze, windspeed")
ggpairs(tripsAgg_Raw[, c("FerienHaufigkeit", "SchleusenSperre", "weekdayEndNumber", "extremeHitze","wspd")], 
        
        # hne Visualisierung des Fortschritts der Erstellung des plots
        progress = FALSE,
        
        # mit Visualisierung einer Glaettungslinie und Aenderung der Farbe der Punkte, damit Linie erkennbar
        lower = list(continuous = wrap("smooth_loess", colour = "aquamarine2")))
cat("sehen alle gut aus, alle Variablen können benutzt werden")
```


# Modell 
```{r}
# Baseline erstellen, 
tripsAgg_Raw$Baseline = mean(tripsAgg_Raw$dauerTourStunden)
## Baseline bewerten 
# DataFrame erzeugen
evaluation = data.frame(Model = "Baseline",
                        MAE = numeric(1),
                        sMAPE = numeric(1))
# MAE berechnen
evaluation[evaluation$Model == "Baseline",]$MAE = mean(abs(tripsAgg_Raw$dauerTourStunden - tripsAgg_Raw$Baseline))
# sMAPE berechnen
evaluation[evaluation$Model == "Baseline",]$sMAPE = smape(tripsAgg_Raw$dauerTourStunden, tripsAgg_Raw$Baseline)
# Einen zufaelligen Zustand herstellen (der jedoch kontrolliert erstellt wird und daher wiederholbar ist)
set.seed(4141)
# eine Zufallsaufwahl erstellen: Aus der Liste von Zahlen 1 bis Laenge von Orders werden 80% gewaehlt
zufall = sample(1:nrow(tripsAgg_Raw), nrow(tripsAgg_Raw) * 0.8)
# Die Eintraege in der Zufallsauswahl gehen in das TrainingsSet
tripsAgg_Raw_Training = tripsAgg_Raw[zufall, ]
head(tripsAgg_Raw_Training)
# Die Eintraege nicht in der Zufallsauswahl gehen in das TestSet
tripsAgg_Raw_Test = tripsAgg_Raw[-zufall, ]
head(tripsAgg_Raw_Test)
#Univariante Modell erstellen
Modell1 = lm(dauerTourStunden ~ FerienHaufigkeit, data = tripsAgg_Raw_Training)
summary(Modell1)
Modell2 = lm(dauerTourStunden ~ SchleusenSperre, data = tripsAgg_Raw_Training)
summary(Modell2)
Modell4 = lm(dauerTourStunden ~ weekdayEndNumber, data = tripsAgg_Raw_Training)
summary(Modell4)
Modell5 = lm(dauerTourStunden ~ extremeHitze, data = tripsAgg_Raw_Training)
summary(Modell5)
Modell6 = lm(dauerTourStunden ~ wspd, data = tripsAgg_Raw_Training)
summary(Modell6)
# Residuenplot 1
ggplot(data = NULL, aes(x = Modell1$model$FerienHaufigkeit, y = Modell1$residuals)) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = loess)
# Residuenplot 2
ggplot(data = NULL, aes(x = Modell2$model$SchleusenSperre, y = Modell2$residuals)) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = loess)
# Residuenplot 4
ggplot(data = NULL, aes(x = Modell4$model$weekdayEndNumber, y = Modell4$residuals)) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = loess)
# Residuenplot 5
ggplot(data = NULL, aes(x = Modell5$model$extremeHitze, y = Modell5$residuals)) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = loess)
# Residuenplot 6
ggplot(data = NULL, aes(x = Modell6$model$wspd, y = Modell5$residuals)) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = loess)
cat("Residuenplots für extreme Hitze und SchleusenSperre sind erwartenderweise nicht perfekt, aber für unser Modell noch ausreichend, die anderen passen")
# Data Frame erweitern
evaluation = rbind(evaluation, data.frame(Model = c("Modell1", "Modell2","Modell4", "Modell5","Modell6"),
                                        MAE = numeric(5),
                                        sMAPE = numeric(5)))
# MAE berechnen
evaluation[evaluation$Model == "Modell1",]$MAE = round(mean(abs(Modell1$residuals)),4)
evaluation[evaluation$Model == "Modell2",]$MAE = round(mean(abs(Modell2$residuals)),4)
evaluation[evaluation$Model == "Modell4",]$MAE = round(mean(abs(Modell4$residuals)),4)
evaluation[evaluation$Model == "Modell5",]$MAE = round(mean(abs(Modell5$residuals)),4)
evaluation[evaluation$Model == "Modell6",]$MAE = round(mean(abs(Modell6$residuals)),4)
# sMAPE berechnen
evaluation[evaluation$Model == "Modell1",]$sMAPE = round(smape(Modell1$model$dauerTourStunden, Modell1$fitted.values),4)
evaluation[evaluation$Model == "Modell2",]$sMAPE = round(smape(Modell2$model$dauerTourStunden, Modell2$fitted.values),4)
evaluation[evaluation$Model == "Modell4",]$sMAPE = round(smape(Modell4$model$dauerTourStunden, Modell4$fitted.values),4)
evaluation[evaluation$Model == "Modell5",]$sMAPE = round(smape(Modell5$model$dauerTourStunden, Modell5$fitted.values),4)
evaluation[evaluation$Model == "Modell6",]$sMAPE = round(smape(Modell6$model$dauerTourStunden, Modell6$fitted.values),4)
# Fehler anzeigen
evaluation
cat("Mit Modell1 wird weitergemacht, da Modell1 die besten Fehlerkennzahlen + den besten R-Squared Wert aufweist")
#BivariantenAufstellen
Modell12 = lm(dauerTourStunden ~ FerienHaufigkeit + SchleusenSperre, data = tripsAgg_Raw_Training)
summary(Modell12)
Modell14 = lm(dauerTourStunden ~ FerienHaufigkeit + weekdayEndNumber, data = tripsAgg_Raw_Training)
summary(Modell14)
Modell15 = lm(dauerTourStunden ~ FerienHaufigkeit + extremeHitze, data = tripsAgg_Raw_Training)
summary(Modell15)
Modell16 = lm(dauerTourStunden ~ FerienHaufigkeit + wspd, data = tripsAgg_Raw_Training)
summary(Modell16)
cat("Alle Werte sind Signifikant")
# Data Frame erweitern
evaluation = rbind(evaluation, data.frame(Model = c("Modell12","Modell14", "Modell15","Modell16"),
                                        MAE = numeric(4),
                                        sMAPE = numeric(4)))
# MAE berechnen
evaluation[evaluation$Model == "Modell12",]$MAE = round(mean(abs(Modell12$residuals)),4)
evaluation[evaluation$Model == "Modell14",]$MAE = round(mean(abs(Modell14$residuals)),4)
evaluation[evaluation$Model == "Modell15",]$MAE = round(mean(abs(Modell15$residuals)),4)
evaluation[evaluation$Model == "Modell16",]$MAE = round(mean(abs(Modell16$residuals)),4)
# sMAPE berechnen
evaluation[evaluation$Model == "Modell12",]$sMAPE = round(smape(Modell12$model$dauerTourStunden, Modell12$fitted.values),4)
evaluation[evaluation$Model == "Modell14",]$sMAPE = round(smape(Modell14$model$dauerTourStunden, Modell14$fitted.values),4)
evaluation[evaluation$Model == "Modell15",]$sMAPE = round(smape(Modell15$model$dauerTourStunden, Modell15$fitted.values),4)
evaluation[evaluation$Model == "Modell16",]$sMAPE = round(smape(Modell16$model$dauerTourStunden, Modell16$fitted.values),4)
evaluation
cat("Mit Modell12 wird weitergemacht, da Modell12 die besten Fehlerkennzahlen aufweist, aber nur knapp besser als Modell1")
#BivariantenAufstellen2
Modell124 = lm(dauerTourStunden ~ FerienHaufigkeit + SchleusenSperre + weekdayEndNumber, data = tripsAgg_Raw_Training)
summary(Modell124)
Modell125 = lm(dauerTourStunden ~ FerienHaufigkeit + SchleusenSperre + extremeHitze, data = tripsAgg_Raw_Training)
summary(Modell125)
Modell126 = lm(dauerTourStunden ~ FerienHaufigkeit + SchleusenSperre + wspd, data = tripsAgg_Raw_Training)
summary(Modell126)
cat("Alle Werte sind Signifikant")
# Data Frame erweitern
evaluation = rbind(evaluation, data.frame(Model = c("Modell124", "Modell125","Modell126"),
                                        MAE = numeric(3),
                                        sMAPE = numeric(3)))
# MAE berechnen
evaluation[evaluation$Model == "Modell124",]$MAE = round(mean(abs(Modell124$residuals)),4)
evaluation[evaluation$Model == "Modell125",]$MAE = round(mean(abs(Modell125$residuals)),4)
evaluation[evaluation$Model == "Modell126",]$MAE = round(mean(abs(Modell126$residuals)),4)
# sMAPE berechnen
evaluation[evaluation$Model == "Modell124",]$sMAPE = round(smape(Modell124$model$dauerTourStunden, Modell124$fitted.values),4)
evaluation[evaluation$Model == "Modell125",]$sMAPE = round(smape(Modell125$model$dauerTourStunden, Modell125$fitted.values),4)
evaluation[evaluation$Model == "Modell126",]$sMAPE = round(smape(Modell126$model$dauerTourStunden, Modell126$fitted.values),4)
evaluation
cat("Mit Modell126 wird weitergemacht, da Modell123 die besten Fehlerkennzahlen aufweist, aber nur knapp besser als Modell1 und Modell12")
#BivariantenAufstellen3
Modell1264 = lm(dauerTourStunden ~ FerienHaufigkeit + SchleusenSperre  + wspd + weekdayEndNumber, data = tripsAgg_Raw_Training)
summary(Modell1234)
Modell1265 = lm(dauerTourStunden ~ FerienHaufigkeit + SchleusenSperre  + wspd + extremeHitze, data = tripsAgg_Raw_Training)
summary(Modell1235)
cat("Alle Werte sind Signifikant")
# Data Frame erweitern
evaluation = rbind(evaluation, data.frame(Model = c("Modell1264", "Modell1265"),
                                        MAE = numeric(2),
                                        sMAPE = numeric(2)))
# MAE berechnen
evaluation[evaluation$Model == "Modell1264",]$MAE = round(mean(abs(Modell124$residuals)),4)
evaluation[evaluation$Model == "Modell1265",]$MAE = round(mean(abs(Modell125$residuals)),4)

# sMAPE berechnen
evaluation[evaluation$Model == "Modell1264",]$sMAPE = round(smape(Modell1234$model$dauerTourStunden, Modell1234$fitted.values),4)
evaluation[evaluation$Model == "Modell1265",]$sMAPE = round(smape(Modell1235$model$dauerTourStunden, Modell1235$fitted.values),4)
evaluation
cat("Die MAE Kennzahlen sind beide schlechter, aber der sMape Wert ist besser, daher wird dennoch weitergemacht.")

#BivariantenAufstellen5
Modell12645 = lm(dauerTourStunden ~ FerienHaufigkeit + SchleusenSperre + extremeHitze + weekdayEndNumber  + wspd, data = tripsAgg_Raw_Training)
summary(Modell12645)
cat("Alle Werte sind Signifikant")
# Data Frame erweitern
evaluation = rbind(evaluation, data.frame(Model = c("Modell12645"),
                                        MAE = numeric(1),
                                        sMAPE = numeric(1)))
# MAE berechnen
evaluation[evaluation$Model == "Modell12645",]$MAE = round(mean(abs(Modell123645$residuals)),4)
# sMAPE berechnen
evaluation[evaluation$Model == "Modell12645",]$sMAPE = round(smape(Modell123645$model$dauerTourStunden, Modell123645$fitted.values),4)
evaluation
cat("Modell12645 ist sozusagen der Gewinner! Also die Variablen: FerienHaufigkeit + SchleusenSperre + weekdayEndNumber + windspeed + extreme Hitze ")
# Daten Testen
# Testen mit dem anderen Set (Test) 
# Vorhersage erzeugen
prediction = predict(Modell12645, tripsAgg_Raw_Test)
# Data Frame erweitern
evaluation = rbind(evaluation, data.frame(Model = c("TestModell12645"),
                                          MAE = numeric(1),
                                         sMAPE = numeric(1)))
# MAE berechnen
evaluation[evaluation$Model == "TestModell12645",]$MAE = round(mae(tripsAgg_Raw_Test$dauerTourStunden,prediction),4)
# sMAPE berechnen
evaluation[evaluation$Model == "TestModell12645",]$sMAPE =  round(smape(tripsAgg_Raw_Test$dauerTourStunden, prediction),4)
# Fehler anzeigen
evaluation
cat("Die Fehlerkennzahlen haben sich nicht verschlechtert, der Seed ist einen Tick besser als unser bestes Modell, daher scheint kein Overfitting vorzuliegen. Es scheint also alles zu passen")
cat("Unser bestes Modell ist gegenüber der Baseline deutlich verbessert!")
```